name: Build
description: Build Linux (Singularity) Images

runs:
  using: "composite"
  steps:

  - name: Install Development Dependencies
    shell: bash
    run: |
      bash -x scripts/linux/setup-for-development-ubuntu.sh

  - name: Store conan setup
    id: conan-cache-key
    shell: bash
    run: |
      echo "path=$(conan config home)" >> $GITHUB_OUTPUT

  - name: Cache conan setup
    uses: actions/cache@v3
    with:
      path: ${{ steps.conan-cache-key.outputs.path }}
      key: conan-${{ matrix.variant.os }}-${{ hashFiles('frontend/cmake/Modules/conan-jv2.cmake') }}

  - name: Build Frontend
    shell: bash
    run: |
      cd frontend
      cmake --preset ci-linux
      cmake --build --preset build

  - name: Build Backend
    shell: bash
    run: |
      cd backend
      python3 -mpip install ".[test]"

  - name: Upload Raw Build Artifacts
    uses: actions/upload-artifact@v3
    with:
      name: linux-build
      path: |
        frontend
        backend
      if-no-files-found: error